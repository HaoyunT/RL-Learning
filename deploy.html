<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>从 PyTorch 到 RK3588：一次完整的 NPU 部署实战与踩坑记录</title>

<!-- Keep styles and scripts consistent with site -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-dracula.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
  MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] } };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
body{margin:0;font-family:Inter,Segoe UI,Roboto,-apple-system,sans-serif;background:linear-gradient(135deg,#0b1020 0%,#161923 60%,#0f1b2a 100%);color:#d7e6df;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
h1,h2,h3,h4{font-family:Merriweather,Georgia,serif}
p,li{font-size:1rem;line-height:1.75;color:#cbd6d1}
code, pre, kbd{font-family:'JetBrains Mono', 'Fira Code', monospace}
header{background:rgba(6,10,18,0.85);padding:20px;text-align:center;backdrop-filter:blur(6px);border-bottom:1px solid rgba(86,171,145,0.06)}
header h1{color:#7ff0c7;margin:0;font-weight:700;letter-spacing:0.6px}
nav ul{list-style:none;display:flex;justify-content:center;gap:8px;padding:0;margin-top:10px}
nav a{color:#b0b5bb;text-decoration:none;padding:6px 12px;border-radius:8px;background:linear-gradient(180deg,rgba(86,171,145,0.06),rgba(86,171,145,0.02));border:1px solid rgba(86,171,145,0.08)}
nav a.active{box-shadow:0 6px 24px rgba(19,211,176,0.06);color:#7ff0c7}
main{max-width:980px;margin:34px auto;padding:22px}
.post{background:linear-gradient(180deg,rgba(12,16,22,0.68),rgba(18,22,28,0.74));border:1px solid rgba(86,171,145,0.06);padding:34px;border-radius:14px;box-shadow:0 18px 48px rgba(2,8,12,0.6)}
.post h2{color:#aaf6d9;margin-bottom:8px;font-size:1.6rem}
.muted{color:#9fb0aa;font-size:0.98rem}

/* 章节标题优化 */
.post h3{
  color:#7ff0c7;
  font-size:1.4rem;
  margin-top:40px;
  margin-bottom:20px;
  padding-left:32px;
  position:relative;
  border-left:4px solid #13d3b0;
  padding-left:20px;
}
.post h3::before{
  content:'';
  position:absolute;
  left:-4px;
  top:50%;
  transform:translateY(-50%);
  width:8px;
  height:8px;
  background:#13d3b0;
  border-radius:50%;
  box-shadow:0 0 12px rgba(19,211,176,0.5);
}
.post h4{
  color:#a7e9d1;
  font-size:1.1rem;
  margin-top:24px;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:8px;
}
.post h4::before{
  content:'▸';
  color:#13d3b0;
  font-size:1.2rem;
}

/* 下载区优化 */
.download-grid{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
.download-btn{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:14px 22px;
  border-radius:12px;
  background:linear-gradient(135deg,#12d3b0,#4fbf88);
  color:#021711;
  font-weight:700;
  text-decoration:none;
  box-shadow:0 8px 24px rgba(19,211,176,0.25);
  transition:all .2s ease;
  border:2px solid rgba(255,255,255,0.1);
}
.download-btn svg{width:20px;height:20px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.download-btn:hover{
  transform:translateY(-4px) scale(1.02);
  box-shadow:0 16px 48px rgba(19,211,176,0.4);
  border-color:rgba(255,255,255,0.3);
}

/* 列表优化 */
.post ul{
  list-style:none;
  padding-left:0;
}
.post ul li{
  padding-left:28px;
  position:relative;
  margin-bottom:8px;
}
.post ul li::before{
  content:'◆';
  position:absolute;
  left:8px;
  color:#13d3b0;
  font-size:0.7rem;
}
.post ul ul li::before{
  content:'◇';
  font-size:0.6rem;
}

/* 代码块优化 */
pre{
  background:linear-gradient(135deg,#051016,#06121a);
  color:#e6f3ee;
  padding:20px;
  border-radius:12px;
  overflow:auto;
  border:1px solid rgba(86,171,145,0.12);
  box-shadow:inset 0 1px 0 rgba(255,255,255,0.03),0 8px 32px rgba(0,0,0,0.6);
  margin:16px 0;
}
pre code{font-family:'JetBrains Mono', 'Fira Code', monospace;font-size:0.92rem;line-height:1.6}
pre .token.comment{color:#7c8b83}
pre .token.string{color:#b7f3d6}
pre .token.keyword{color:#9be8c9}
pre .token.function{color:#a7e9d1}

/* 行内代码优化 */
code{
  background:rgba(19,211,176,0.1);
  color:#7ff0c7;
  padding:2px 6px;
  border-radius:4px;
  font-size:0.9em;
  border:1px solid rgba(19,211,176,0.2);
}
pre code{
  background:none;
  border:none;
  padding:0;
}

/* 强调文本 */
strong{
  color:#aaf6d9;
  font-weight:600;
}

/* 分隔线优化 */
hr{
  border:none;
  height:1px;
  background:linear-gradient(90deg,transparent,rgba(86,171,145,0.3),transparent);
  margin:40px 0;
}

/* 特殊提示框 */
.post p[style*="color: #9fb0aa"]{
  background:rgba(86,171,145,0.08);
  padding:12px 16px;
  border-radius:8px;
  border-left:3px solid #13d3b0;
  margin:16px 0;
}

.post h2{position:relative}
.post h2::after{content:'';position:absolute;right:0;top:50%;transform:translateY(-50%);width:120px;height:4px;background:linear-gradient(90deg,#7ff0c7,#13d3b0);border-radius:6px;opacity:0.15}
</style>

</head>
<body>
<header>
  <h1>工程实践与部署</h1>
  <nav>
    <ul>
      <li><a href="index.html">首页</a></li>
      <li><a href="home.html">基础理论</a></li>
      <li><a href="advanced.html">进阶算法</a></li>
      <li><a href="MARL.html">多智能体学习</a></li>
      <li><a href="deploy.html" class="active">工程实践与部署</a></li>
      <li><a href="papers.html">论文研读</a></li>
    </ul>
  </nav>
</header>

<main>
  <article class="post">
    <h2> RK3588 NPU 部署完全指南</h2>
    <p class="muted">从 PyTorch 模型到板端 100Hz 实时推理的完整流程，涵盖模型转换、板端部署、性能验证和生产环境配置。</p>

    <div style="background: linear-gradient(135deg, rgba(127,240,199,0.08), rgba(19,211,176,0.08)); padding: 20px; border-radius: 12px; border-left: 4px solid #13d3b0; margin: 24px 0;">
      <h3 style="margin-top: 0; color: #7ff0c7; font-size: 1.3rem;"> Part 1: PC 端 - Ubuntu 22.04 环境搭建与模型转换</h3>
      <p style="margin-bottom: 0; color: #cbd6d1;">在 PC 上安装 RKNN Toolkit2，完成 PyTorch → ONNX → RKNN 模型转换</p>
    </div>

    <h3>Ubuntu 22.04 装 RKNN Toolkit2 踩坑记录</h3>
    <p class="muted">记一下重点。Ubuntu 22.04 上装这个有三个坑：</p>
    <ul>
      <li>必须 Python 3.8（系统自带 3.10 不行）</li>
      <li>必须虚拟环境（直接装系统 Python 会炸）</li>
      <li>包名是 <code>rknn_toolkit2</code> 带下划线，PyPI 上那个是假的</li>
    </ul>
    <p>这三条哪个不对后面都会报错。</p>

    <h4>1. 装系统依赖</h4>
    <p>先把该装的基础包装上：</p>
    <pre><code class="language-bash">sudo apt update
sudo apt install -y \
    build-essential cmake git wget unzip \
    libglib2.0-0 libsm6 libxrender1 libxext6</code></pre>

    <p>装 Python 3.8（22.04 不自带）：</p>
    <pre><code class="language-bash">sudo apt install -y python3.8 python3.8-dev python3.8-venv

# 确认一下版本
python3.8 --version</code></pre>

    <h4>2. 搞虚拟环境</h4>
    <p>建个虚拟环境，别污染系统 Python：</p>
    <pre><code class="language-bash">mkdir -p ~/envs
cd ~/envs
python3.8 -m venv rknn_env

# 激活（命令行前面会出现 (rknn_env) ）
source ~/envs/rknn_env/bin/activate

# 检查一下
which python       # 应该是 ~/envs/rknn_env/bin/python
python --version   # 应该是 Python 3.8.x</code></pre>
    <p style="color: #ff8787;">路径不对或版本不是 3.8 就别往下走了。</p>

    <p>升级 pip：</p>
    <pre><code class="language-bash">pip install --upgrade pip setuptools wheel</code></pre>

    <h4>3. 下载源码</h4>
    <pre><code class="language-bash">cd ~
git clone https://github.com/rockchip-linux/rknn-toolkit2.git
cd rknn-toolkit2
git checkout master</code></pre>

    <h4>4. 装包</h4>
    <p>确认虚拟环境还在（echo $VIRTUAL_ENV 能看到路径就行）：</p>
    <pre><code class="language-bash"># 装依赖（注意是 cp38 那个）
pip install -r packages/requirements_cp38.txt

# 装主程序
pip install packages/rknn_toolkit2-*.whl</code></pre>
    <p style="color: #ffb84d;">别直接 pip install rknn-toolkit2，PyPI 那个不全。</p>

    <h4>5. 装模型转换所需的库</h4>
    <p>只装转换需要的：</p>
    <pre><code class="language-bash"># PyTorch（加载模型和导出 ONNX 用，CPU 版本就够了）
pip install torch --index-url https://download.pytorch.org/whl/cpu

# ONNX（转换中间格式）
pip install onnx</code></pre>

    <h4>6. 测试一下</h4>
    <pre><code class="language-bash">python - &lt;&lt; EOF
from rknn.api import RKNN
print("装好了")
EOF</code></pre>
    <p>能 print 出来就说明成功了。每次新开终端记得激活：<code>source ~/envs/rknn_env/bin/activate</code></p>

    <h4>7. 下载模型转换示例代码</h4>
    <p>装好 RKNN Toolkit2 后，下载我的模型转换示例：</p>
    
    <div class="download-grid">
      <a href="rknn_test.zip" download class="download-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        下载 rknn_test.zip
      </a>
    </div>

    <p><strong>包里都有啥：</strong></p>
    <ul>
      <li><code>export_maddpg_actors_to_onnx.py</code> - PyTorch → ONNX 转换脚本</li>
      <li><code>onnx_to_rknn_maddpg.py</code> - ONNX → RKNN 转换脚本（核心）</li>
      <li><code>pc_make_torch_out.py</code> - 生成 PyTorch 参考输出（用于验证）</li>
      <li><code>board_validate.py</code> - 板端验证脚本</li>
      <li><code>agent_*_actor</code> - 训练好的 PyTorch 模型权重</li>
      <li><code>actor_agent*.onnx</code> - 转换好的 ONNX 模型</li>
      <li><code>actor_agent*.rknn</code> - 转换好的 RKNN 模型</li>
      <li><code>networks.py / maddpg.py / agent.py</code> - 网络结构定义</li>
    </ul>

    <p><strong>怎么用：</strong></p>
    <pre><code class="language-bash"># 1. 激活虚拟环境
source ~/envs/rknn_env/bin/activate

# 2. PyTorch 模型 → ONNX
python export_maddpg_actors_to_onnx.py

# 3. ONNX → RKNN（不量化，保证精度）
python onnx_to_rknn_maddpg.py

# 4. 生成参考输出（用于板端对比验证）
python pc_make_torch_out.py</code></pre>

    <p style="margin-top: 12px; color: #9fb0aa;">
      <strong>重点：</strong>转换时设置 <code>do_quantization=False</code>，保证和 PyTorch 输出一致。
    </p>

    <hr style="border: none; border-top: 1px solid rgba(86,171,145,0.15); margin: 40px 0;">

    <div style="background: linear-gradient(135deg, rgba(255,184,77,0.08), rgba(255,144,77,0.08)); padding: 20px; border-radius: 12px; border-left: 4px solid #ffb84d; margin: 24px 0;">
      <h3 style="margin-top: 0; color: #ffb84d; font-size: 1.3rem;"> Part 2: 板端 - RK3588 部署与验证</h3>
      <p style="margin-bottom: 0; color: #cbd6d1;">在 RK3588 开发板上部署 C 程序，实现 100Hz 实时推理和系统服务</p>
    </div>

    <h3>0. 你要达到的最终状态</h3>
    <ul>
      <li>在 RK3588 上能运行：<code>./verify_rknn</code>（推理验证工具）和 <code>./actor_daemon</code>（常驻部署程序）。</li>
      <li>实现以下功能：
        <ul>
          <li>推理验证（数值一致性/性能/稳定性/极值输入）。</li>
          <li>开机自启动 + 崩溃自动重启（systemd）。</li>
        </ul>
      </li>
    </ul>

    <h3>1. 新板子基础配置</h3>
    <h4>1.1 登录板子并确认架构</h4>
    <pre><code class="language-bash">uname -m</code></pre>
    <p>应输出 <code>aarch64</code>（RK3588 是 ARM64）。</p>

    <h4>1.2 更新系统 + 安装编译工具</h4>
    <pre><code class="language-bash">sudo apt update
sudo apt upgrade -y
sudo apt install -y build-essential cmake git pkg-config</code></pre>

    <h3>2. 安装 RKNN Runtime（librknnrt）</h3>
    <p>重点：apt 装不到，必须来自 rknpu2 SDK（或厂商 SDK）。</p>

    <h4>2.1 找到你的 rknpu2 SDK 目录</h4>
    <p>板子上常见路径：</p>
    <pre><code class="language-bash">ls /home/khadas/khadas/rknpu2/runtime/RK3588/Linux/</code></pre>
    <p>应该能看到：</p>
    <pre><code>librknnrt.so / librknnrt.so.1
librknn_api/include/rknn_api.h</code></pre>

    <h4>2.2 安装到系统目录（推荐，最稳）</h4>
    <p>假设你的路径就是 Khadas 那套：</p>
    <pre><code class="language-bash">sudo cp /home/khadas/khadas/rknpu2/runtime/RK3588/Linux/librknnrt.so* /usr/lib/
sudo ldconfig</code></pre>
    <p>验证：</p>
    <pre><code class="language-bash">ldconfig -p | grep rknn</code></pre>
    <p>应该能看到 <code>librknnrt.so</code>。</p>

    <h3>3. 建项目目录</h3>
    <pre><code class="language-bash">mkdir -p ~/rknn_deploy_demo
cd ~/rknn_deploy_demo</code></pre>
    <p>把你的 <code>.rknn</code> / <code>obs.bin</code> / <code>torch_out.bin</code> 放这里。</p>

    <h3>4. 下载完整示例代码</h3>
    <p>环境配好了，现在下载我打包好的完整代码：</p>
    
    <div class="download-grid">
      <a href="rknn_c.zip" download class="download-btn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        下载 rknn_c.zip
      </a>
    </div>

    <h4>4.1 包里都有啥</h4>
    <p><strong>核心 C 程序：</strong></p>
    <ul>
      <li><code>npu_daemon.c</code> - 100Hz 推理守护进程，后台常驻运行</li>
      <li><code>rknn_validate.c</code> - 验证工具，测试数值一致性和性能</li>
      <li><code>main.c</code> - 简单的推理示例（可忽略）</li>
    </ul>

    <p><strong>编译和部署脚本：</strong></p>
    <ul>
      <li><code>compile_daemon.sh</code> - 编译守护进程</li>
      <li><code>compile_validate.sh</code> - 编译验证工具</li>
      <li><code>deploy_npu_system.sh</code> - 一键部署脚本（推荐）</li>
      <li><code>install_daemon.sh</code> - 安装 systemd 服务</li>
      <li><code>test_daemon.sh</code> - 测试守护进程</li>
    </ul>

    <p><strong>systemd 配置：</strong></p>
    <ul>
      <li><code>rk3588-npu-daemon.service</code> - systemd 服务配置文件，设置自启动和崩溃重启</li>
    </ul>

    <p><strong>测试数据：</strong></p>
    <ul>
      <li><code>actor_agent*.rknn</code> - 四个智能体的 RKNN 模型</li>
      <li><code>obs_actor_*.bin</code> - PyTorch 测试输入（26 维 float32）</li>
      <li><code>torch_out_actor_*.bin</code> - PyTorch 参考输出（2 维 float32）</li>
    </ul>

    <p><strong>文档：</strong></p>
    <ul>
      <li><code>SYSTEM_OVERVIEW.md</code> - 完整的系统架构说明</li>
      <li><code>使用文档.txt</code> - 快速上手指令</li>
    </ul>

    <h4>4.2 怎么用</h4>
    <p><strong>快速部署（推荐）：</strong></p>
    <pre><code class="language-bash"># 解压后进入目录
cd rknn_c

# 一键部署（编译+安装+启动）
chmod +x *.sh
sudo ./deploy_npu_system.sh

# 查看运行状态
sudo systemctl status rk3588-npu-daemon</code></pre>

    <p><strong>分步测试：</strong></p>
    <pre><code class="language-bash"># 1. 编译验证工具
./compile_validate.sh

# 2. 验证模型（确保数值和 PyTorch 一致）
./validate_rknn actor_agent0.rknn obs_actor_0.bin torch_out_actor_0.bin

# 3. 测试守护进程（不安装服务）
./test_daemon.sh</code></pre>

  
  </article>
</main>

<footer style="text-align:center;padding:20px;color:#9aa3a9">© 2025 强化学习笔记</footer>

</body>
</html>